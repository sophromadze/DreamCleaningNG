<div class="user-management-section">
  <h2>User Management</h2>
  <div class="messages">
    <div class="error-message" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
    <div class="success-message" *ngIf="successMessage">
      {{ successMessage }}
    </div>
  </div>
  <div class="filters-section">
    <div class="search-box">
      <input type="text"
             [(ngModel)]="searchTerm"
             placeholder="Search by ID or email..."
             class="search-input">
    </div>
    <div class="filter-controls">
      <select [(ngModel)]="statusFilter" class="filter-select">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select [(ngModel)]="roleFilter" class="filter-select">
        <option value="all">All Roles</option>
        <option value="SuperAdmin">SuperAdmin</option>
        <option value="Admin">Admin</option>
        <option value="Moderator">Moderator</option>
        <option value="Customer">Customer</option>
      </select>
    </div>
  </div>
  <div class="users-list">
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Role</th>
            <th>Provider</th>
            <th>Subscription</th>
            <th>First Time</th>
            <th>Status</th>
            <th *ngIf="userRole !== 'Moderator'">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers">
            <td>{{ user.id }}</td>
            <td>{{ user.firstName }} {{ user.lastName }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.phone || 'N/A' }}</td>
            <td>
              <span class="role-badge" 
                    [class.superadmin]="user.role === 'SuperAdmin'"
                    [class.admin]="user.role === 'Admin'"
                    [class.moderator]="user.role === 'Moderator'"
                    [class.customer]="user.role === 'Customer'">
                {{ user.role }}
              </span>
            </td>
            <td>{{ user.authProvider || 'Local' }}</td>
            <td>{{ user.subscriptionName || 'None' }}</td>
            <td>
              <span class="badge" [class.bg-success]="user.firstTimeOrder" [class.bg-secondary]="!user.firstTimeOrder">
                {{ user.firstTimeOrder ? 'Yes' : 'No' }}
              </span>
            </td>
            <td>
              <span class="status-badge" 
                    [class.active]="user.isActive" 
                    [class.inactive]="!user.isActive">
                {{ user.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td *ngIf="userRole !== 'Moderator'">
              <!-- Status Actions -->
              <button class="action-btn deactivate" 
                      *ngIf="canBanUser(user)" 
                      (click)="updateUserStatus(user, false)">
                Block
              </button>
              <button class="action-btn activate" 
                      *ngIf="canUnbanUser(user)" 
                      (click)="updateUserStatus(user, true)">
                Unblock
              </button>

              <!-- Role Change Dropdown -->
             <div class="role-dropdown" *ngIf="canModifyUserRole(user)">
               <button class="dropdown-toggle" 
                       (click)="toggleRoleDropdown(user.id)"
                       [attr.title]="getRoleButtonTooltip(user)">
                 Role
                 <span class="chevron">â–¼</span>
               </button>
               <div class="dropdown-menu" *ngIf="roleDropdownUserId === user.id">
                 <a class="dropdown-item" 
                    [class.disabled]="!canChangeUserRole(user, 'Customer')"
                    (click)="canChangeUserRole(user, 'Customer') && updateUserRole(user, 'Customer')">
                   Customer
                 </a>
                 <a class="dropdown-item" 
                    [class.disabled]="!canChangeUserRole(user, 'Moderator')"
                    (click)="canChangeUserRole(user, 'Moderator') && updateUserRole(user, 'Moderator')">
                   Moderator
                 </a>
                 <a class="dropdown-item" 
                    [class.disabled]="!canChangeUserRole(user, 'Admin')"
                    (click)="canChangeUserRole(user, 'Admin') && updateUserRole(user, 'Admin')">
                   Admin
                 </a>
                 <a class="dropdown-item" 
                    *ngIf="currentUserRole === 'SuperAdmin'"
                    [class.disabled]="!canChangeUserRole(user, 'SuperAdmin')"
                    (click)="canChangeUserRole(user, 'SuperAdmin') && updateUserRole(user, 'SuperAdmin')">
                   SuperAdmin
                 </a>
               </div>
             </div>
             
             <!-- Show a message when role dropdown is not available -->
             <span class="role-locked" 
                   *ngIf="!canModifyUserRole(user) && canUpdate" 
                   [attr.title]="getRoleButtonTooltip(user)">
               ðŸ”’Locked
             </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" (click)="previousPage()" [disabled]="currentPage === 1">Previous</button>
      <ng-container *ngFor="let page of [].constructor(totalPages); let i = index">
        <button class="page-btn" [class.active]="currentPage === (i+1)" (click)="goToPage(i+1)" [disabled]="currentPage === (i+1)">{{i+1}}</button>
      </ng-container>
      <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
    </div>
  </div>
</div> 