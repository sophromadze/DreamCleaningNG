<div class="booking-container">
  <div class="booking-content">
    <h1>Book Your Cleaning Service</h1>
    
    <div class="error-message" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>

    <div class="booking-grid" 
         [class.full-width]="showPollForm"
         [class.has-summary]="selectedServiceType && !showPollForm">
      <!-- Left Side - Service Selection -->
      <div class="booking-form">
        <div class="clear-form-section" *ngIf="formPersistenceService.hasSavedData()">
          <button class="clear-all-btn" (click)="clearAllFormData()">
            Clear All
          </button>
        </div>
        
        <!-- Step 1: Service Type Selection - ALWAYS VISIBLE -->
        <section class="booking-section">
          <h2>Select Service Type</h2>
          <div class="service-type-selection">
            <div class="form-group">
              <label>Service Type <span class="required">*</span></label>
              <div class="service-type-dropdown">
                <button 
                  type="button"
                  class="dropdown-toggle"
                  (click)="toggleServiceTypeDropdown()"
                  [disabled]="isLoading">
                  <span>{{ selectedServiceType ? selectedServiceType.name : 'Select a service type' }}</span>
                  <span class="chevron">▼</span>
                </button>
                <div class="dropdown-menu" *ngIf="serviceTypeDropdownOpen">
                  <button 
                    *ngFor="let type of serviceTypes" 
                    type="button"
                    class="dropdown-item"
                    (click)="selectServiceType(type)">
                    {{ type.name }}
                  </button>
                </div>
              </div>
              <div class="error-message" *ngIf="serviceTypeControl.invalid && serviceTypeControl.touched">
                <div *ngIf="serviceTypeControl.errors?.['required']">Service type is required</div>
              </div>
            </div>
            
            <!-- Service Type Description -->
            <div class="service-type-description" *ngIf="selectedServiceType">
              <div class="description-content">
                <p>{{ selectedServiceType.description }}</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Poll Form Section (when service type has poll) -->
        <section class="booking-section" *ngIf="selectedServiceType && showPollForm">
          <h2>Tell us about your cleaning needs</h2>
          <p class="poll-description">
            Please answer the following questions so we can provide you with a customized quote.
          </p>
          
          <div class="poll-questions">
            <div class="poll-question" *ngFor="let question of pollQuestions; let questionIndex = index">
              <label class="question-label">
                {{ question.question }}
                <span class="required" *ngIf="question.isRequired">*</span>
              </label>
              
              <!-- Text Input -->
              <input 
                *ngIf="question.questionType === 'text'"
                type="text" 
                [(ngModel)]="pollAnswers[question.id]"
                [required]="question.isRequired"
                class="poll-input"
                [class.ng-invalid]="pollFormSubmitted && question.isRequired && (!pollAnswers[question.id] || pollAnswers[question.id].trim() === '')">
              
              <!-- Textarea -->
              <textarea 
                *ngIf="question.questionType === 'textarea'"
                [(ngModel)]="pollAnswers[question.id]"
                [required]="question.isRequired"
                rows="3"
                class="poll-textarea"
                [class.ng-invalid]="pollFormSubmitted && question.isRequired && (!pollAnswers[question.id] || pollAnswers[question.id].trim() === '')"></textarea>
              
              <!-- Dropdown -->
              <select 
                *ngIf="question.questionType === 'dropdown'"
                [(ngModel)]="pollAnswers[question.id]"
                [required]="question.isRequired"
                class="poll-select"
                [class.ng-invalid]="pollFormSubmitted && question.isRequired && (!pollAnswers[question.id] || pollAnswers[question.id].trim() === '')">
                <option value="">Select an option</option>
                <option *ngFor="let option of question.options?.split(',') || []" [value]="option.trim()">
                  {{ option.trim() }}
                </option>
              </select>
              
              <!-- Radio buttons -->
              <div *ngIf="question.questionType === 'radio'" class="radio-group">
                <div *ngFor="let option of question.options?.split(',') || []; let i = index" class="radio-option">
                  <input 
                    type="radio" 
                    [name]="'question_' + question.id"
                    [id]="'question_' + question.id + '_' + i"
                    [value]="option.trim()"
                    [(ngModel)]="pollAnswers[question.id]"
                    [required]="question.isRequired">
                  <label [for]="'question_' + question.id + '_' + i">{{ option.trim() }}</label>
                </div>
              </div>
              
              <!-- Single error message per question -->
              <div class="poll-error-message" 
                   *ngIf="pollFormSubmitted && question.isRequired && (!pollAnswers[question.id] || pollAnswers[question.id].trim() === '')" 
                   [attr.data-question-id]="question.id"
                   [attr.data-question-index]="questionIndex">
                Please answer the question
              </div>
            </div>
          </div>
        </section>

        <!-- Custom Pricing Section (when service type has custom pricing) -->
        <section class="booking-section" *ngIf="selectedServiceType && showCustomPricing">
          <h2>Custom Service Details</h2>
          <p class="custom-description">
            Please specify your custom cleaning requirements below.
          </p>

          <div class="custom-pricing-form">
            <div class="form-group">
              <label>Service Amount <span class="required">*</span></label>
              <div class="input-group">
                <input type="number" 
                       [formControl]="customAmount"
                       min="0.01"
                       step="0.01"
                       placeholder="0.00"
                       class="amount-input"
                       id="customAmount">
                <span class="input-suffix">$</span>
              </div>
              <div class="error-message" *ngIf="customAmount.invalid && customAmount.touched">
                <div *ngIf="customAmount.errors?.['required']">Amount is required</div>
                <div *ngIf="customAmount.errors?.['min']">Amount must be greater than 0</div>
              </div>
            </div>

            <div class="form-group">
              <label>Number of Cleaners <span class="required">*</span></label>
              <select [formControl]="customCleaners" id="customCleaners">
                <option *ngFor="let num of [1,2,3,4,5,6,7,8,9,10]" [value]="num">
                  {{num}} {{num === 1 ? 'Cleaner' : 'Cleaners'}}
                </option>
              </select>
              <div class="error-message" *ngIf="customCleaners.invalid && customCleaners.touched">
                <div *ngIf="customCleaners.errors?.['required']">Number of cleaners is required</div>
              </div>
            </div>

            <div class="form-group">
              <label>Duration <span class="required">*</span></label>
              <app-duration-selector 
                [value]="customDuration.value" 
                (valueChange)="onDurationChange($event)">
              </app-duration-selector>
              <div class="error-message" *ngIf="customDuration.invalid && customDuration.touched">
                <div *ngIf="customDuration.errors?.['required']">Duration is required</div>
                <div *ngIf="customDuration.errors?.['min']">Duration must be at least 1 hour</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Regular Booking Sections (ONLY services and extra services - hidden for poll and custom) -->
<ng-container *ngIf="selectedServiceType && !showPollForm && !showCustomPricing">
  <!-- Step 2: Services -->
  <section class="booking-section">
    <h2>Customize Your Service</h2>
    
    <!-- Office Cleaning Pricing Text -->
    <div class="service-pricing-info" *ngIf="hasCleanerServices()">
      <p class="pricing-text" [innerHTML]="getCleanerPricingText()"></p>
    </div>
    
    <div class="services">
      <div class="service-item" *ngFor="let selected of selectedServices">
        <label>{{ selected.service.name }}</label>
        
        <!-- Dropdown Input -->
        <div class="service-input" *ngIf="selected.service.inputType === 'dropdown'">
          <select [(ngModel)]="selected.quantity" 
                  (change)="updateServiceQuantity(selected.service, +selected.quantity)">
            <option *ngFor="let option of getServiceOptions(selected.service)"
                    [value]="option">
              <ng-container *ngIf="selected.service.serviceKey === 'bedrooms' && option === 0">Studio</ng-container>
              <ng-container *ngIf="!(selected.service.serviceKey === 'bedrooms' && option === 0)">{{ option }}</ng-container>
            </option>
          </select>
          <!-- Removed duration and cost display -->
        </div>

        <!-- Slider Input for Square Feet -->
        <div class="service-input slider-input" *ngIf="selected.service.isRangeInput">
          <div class="slider-container">
            <!-- <div class="slider-header">            
              
            </div>   -->
            <input type="range"
                  [(ngModel)]="selected.quantity"
                  [min]="selected.service.minValue"
                  [max]="selected.service.maxValue"
                  [step]="selected.service.stepValue"
                  (input)="updateServiceQuantity(selected.service, +selected.quantity)">
                  <span class="slider-quantity">{{ selected.quantity }} sq ft</span>
              <!-- Removed cost display -->
          </div>                  
        </div>
      </div>
    </div>
  </section>

  <!-- Step 3: Extra Services -->
  <section class="booking-section">
    <h2>Add Extra Services</h2>
    
    <div class="extra-services-info">
      <p><strong>Deep Cleaning Includes:</strong> Inside of the Fridge and inside the oven. All other services you must select by yourself.</p>
      <p><strong>We will not be able to do the following:</strong></p>
      <ul>
        <li>Moving Heavy Furniture and Appliances</li>
        <li>Exterior Window Cleaning</li>
        <li>Pet Waste</li>
      </ul>
    </div>
    
    <!-- Cleaning Type Selection -->
    <div class="cleaning-type-selection">
      <label>Cleaning Type <span class="required">*</span></label>
      <select [formControl]="cleaningType" (change)="onCleaningTypeChange(cleaningType.value)" id="cleaningType">
        <option value="normal">Regular Cleaning</option>
        <option value="deep">Deep Cleaning</option>
        <option value="super-deep">Super Deep Cleaning</option>
      </select>
      <div class="error-message" *ngIf="cleaningType.invalid && cleaningType.touched">
        <div *ngIf="cleaningType.errors?.['required']">Cleaning type is required</div>
      </div>
    </div>

    <div class="extra-services">
      <div class="extra-service-card"
            *ngFor="let extra of getFilteredExtraServices()"
            [class.selected]="isExtraServiceSelected(extra)"
            [class.mobile-tooltip-visible]="isMobileTooltipVisible(extra.id)"
            (click)="toggleExtraService(extra)"
            [attr.data-tooltip]="getExtraServiceTooltip(extra)">
        <div class="extra-header">
          <div class="extra-top-controls">
            <div class="extra-icon">
              <i [class]="getExtraServiceIcon(extra)"></i>
            </div>
            <div class="checkbox">
              <input type="checkbox" [checked]="isExtraServiceSelected(extra)" style="pointer-events: none; cursor: default;">
            </div>
          </div>
          <div class="extra-info">
            <h4>{{ extra.name }}</h4>
            <div class="extra-details">
              <!-- Removed price and duration display -->
            </div>
          </div>
        </div>
        
        <!-- Quantity Control -->
        <div class="extra-controls" *ngIf="isExtraServiceSelected(extra) && (extra.hasQuantity || extra.hasHours)">
          <div class="quantity-control" *ngIf="extra.hasQuantity">
            <label>Qty:</label>
            <div class="control-buttons">
              <button (click)="updateExtraServiceQuantity(extra, getExtraServiceQuantity(extra) - 1); $event.stopPropagation()" 
                      [disabled]="getExtraServiceQuantity(extra) <= 1">-</button>
              <span>{{ getExtraServiceQuantity(extra) }}</span>
              <button (click)="updateExtraServiceQuantity(extra, getExtraServiceQuantity(extra) + 1); $event.stopPropagation()">+</button>
            </div>
          </div>
          
          <!-- Hours Control -->
          <div class="hours-control" *ngIf="extra.hasHours">
            <label>Hours:</label>
            <div class="control-buttons">
              <button (click)="updateExtraServiceHours(extra, getExtraServiceHours(extra) - 0.5); $event.stopPropagation()" 
                      [disabled]="getExtraServiceHours(extra) <= 0.5">-</button>
              <span>{{ getExtraServiceHours(extra) }}</span>
              <button (click)="updateExtraServiceHours(extra, getExtraServiceHours(extra) + 0.5); $event.stopPropagation()">+</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</ng-container>

<!-- Common sections for both regular and custom pricing (hidden only for poll) -->
<ng-container *ngIf="selectedServiceType && !showPollForm">
  <!-- Step 4/2: Date & Time -->
  <section class="booking-section">
    <h2>Select Date & Time</h2>
    <div class="date-time-selection">
      <div class="form-group">
        <label>Service Date <span class="required">*</span></label>
        <app-date-selector 
          [value]="serviceDate.value" 
          [minDate]="minDate.toISOString().split('T')[0]"
          [isSameDaySelected]="isSameDaySelected"
          (valueChange)="onDateSelectorChange($event)">
        </app-date-selector>
        <div class="error-message" *ngIf="serviceDate.invalid && serviceDate.touched">
          <div *ngIf="serviceDate.errors?.['required']">Service date is required</div>
        </div>
      </div>
      <div class="form-group">
        <label>Service Time <span class="required">*</span></label>
        <app-time-selector 
          [value]="serviceTime.value" 
          [availableTimeSlots]="getAvailableTimeSlots()"
          (valueChange)="onTimeChange($event)">
        </app-time-selector>
        <div class="error-message" *ngIf="serviceTime.invalid && serviceTime.touched">
          <div *ngIf="serviceTime.errors?.['required']">Service time is required</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 5/3: Subscription -->
  <section class="booking-section">
    <h2>Select Subscription</h2>
    <div class="active-subscription-notice" *ngIf="hasActiveSubscription && userSubscription">
      <i class="fas fa-info-circle"></i>
      <span>You have an active {{ userSubscription?.subscriptionName }} subscription 
            ({{ userSubscription?.discountPercentage }}% discount)</span>
    </div>
    <div class="subscription-options">
      <div class="subscription-card"
           *ngFor="let subscription of subscriptions"
           [class.selected]="selectedSubscription?.id === subscription.id"
           [class.user-subscription]="hasActiveSubscription && userSubscription?.subscriptionId === subscription.id"
           (click)="selectSubscription(subscription)">
        <h4>{{ subscription.name }}</h4>
        <p>{{ subscription.description }}</p>
        <div class="discount" *ngIf="subscription.discountPercentage > 0">
          Save {{ subscription.discountPercentage }}%
        </div>
        <div class="current-subscription" 
           *ngIf="hasActiveSubscription && userSubscription?.subscriptionId === subscription.id">
          Your Current Plan
        </div>
      </div>
    </div>
  </section>

  <!-- Step 6/4: Discounts -->
  <section class="booking-section">
    <h2>Apply Discounts</h2>
    
    <!-- Show error message if there is one -->
    <div class="discount-error" *ngIf="errorMessage">
      <p class="error-message">{{ errorMessage }}</p>
    </div>
    
    <div class="discounts">
      <!-- Special Offers Section -->
      <div class="special-offers-section" *ngIf="userSpecialOffers.length > 0">
        <h3>Available Special Offers</h3>
        <div class="special-offers-grid">
          <div class="special-offer-card"
                *ngFor="let offer of userSpecialOffers"
                [class.applied]="specialOfferApplied && selectedSpecialOffer?.id === offer.id">
            <div class="offer-info">
              <span class="offer-badge" [style.background-color]="offer.badgeColor || '#28a745'">
                <i class="fas fa-gift"></i>
              </span>
              <div class="offer-content">
                <h4>{{ offer.name }}</h4>
                <div class="offer-details">
                  <p *ngIf="offer.description">{{ offer.description }}</p>
                  <span class="offer-expiry" *ngIf="offer.expiresAt">
                    Expires: {{ offer.expiresAt | date: 'MMM d, y' }}
                  </span>
                  <span class="offer-minimum" *ngIf="offer.minimumOrderAmount">
                    Min. order: ${{ offer.minimumOrderAmount }}
                  </span>
                </div>
              </div>
            </div>
            <div class="offer-actions">
              <button
                class="apply-btn"
                (click)="applySpecialOffer(offer)"
                [disabled]="specialOfferApplied && selectedSpecialOffer?.id === offer.id">
                {{ (specialOfferApplied && selectedSpecialOffer?.id === offer.id) ? 'Applied' : 'Apply' }}
              </button>
              <button
                class="remove-btn"
                (click)="removeSpecialOffer()"
                *ngIf="specialOfferApplied && selectedSpecialOffer?.id === offer.id">
                Remove
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Promo Code Section -->
      <div class="promo-code-section">
        <div class="promo-code">
          <label>Promo Code or Gift Card</label>
          <div class="promo-input">
            <input
              type="text"
              [formControl]="promoCode"
              placeholder="Enter promo code or gift card code">
            <button
              (click)="applyPromoCode()"
              [disabled]="isPromoCodeDisabled()">
              Apply
            </button>
            <button
              class="remove-btn"
              (click)="removePromoCode()"
              *ngIf="promoCodeApplied || giftCardApplied">
              Remove
            </button>
          </div>
          <p class="promo-note" *ngIf="specialOfferApplied">
            <i class="fas fa-info-circle"></i> Remove special offer to use a promo code
          </p>
        </div>
      </div>
      
      <!-- Gift Card Applied Message -->
      <div class="gift-card-applied" *ngIf="giftCardApplied && isGiftCard">
        <div class="gift-card-info">
          <div class="gift-card-icon">🎁</div>
          <div class="gift-card-details">
            <div class="gift-card-title">Gift Card Applied</div>
            <div class="gift-card-amounts">
              <span class="amount-using">${{ getGiftCardDisplayInfo().amountToUse.toFixed(2) }} will be used</span>
              <span class="remaining-balance" *ngIf="getGiftCardDisplayInfo().remainingBalance > 0">
                ${{ getGiftCardDisplayInfo().remainingBalance.toFixed(2) }} remaining
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 7/5: Tips for Cleaners -->
  <section class="booking-section">
    <h2>Tips for Cleaners</h2>
    <div class="tips-section">
      <p>Your cleaners work hard to make your space shine!</p>
      <div class="tip-options">
        <button [class.selected]="tips.value === 0" 
                (click)="tips.setValue(0)">$0</button>
        <button [class.selected]="tips.value === 10" 
                (click)="tips.setValue(10)">$10</button>
        <button [class.selected]="tips.value === 15" 
                (click)="tips.setValue(15)">$15</button>
        <button [class.selected]="tips.value === 20" 
                (click)="tips.setValue(20)">$20</button>
        <button [class.selected]="tips.value === 25" 
                (click)="tips.setValue(25)">$25</button>
        <div class="custom-tip">
          <input type="number" [formControl]="tips" min="0" placeholder="Custom amount">
          <div class="error-message" *ngIf="tips.errors?.['minTipAmount']">
            Custom tip amount must be at least $10
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 8/6: Tips for Company Development -->
  <section class="booking-section" style="display: none;">
    <h2>Tips for Company Development</h2>
    <div class="tips-section">
      <p>Support our company's growth and improvement initiatives!</p>
      <div class="tip-options">
        <button [class.selected]="companyDevelopmentTips.value === 0" 
                (click)="companyDevelopmentTips.setValue(0)">$0</button>
        <button [class.selected]="companyDevelopmentTips.value === 10" 
                (click)="companyDevelopmentTips.setValue(10)">$10</button>
        <button [class.selected]="companyDevelopmentTips.value === 15" 
                (click)="companyDevelopmentTips.setValue(15)">$15</button>
        <button [class.selected]="companyDevelopmentTips.value === 20" 
                (click)="companyDevelopmentTips.setValue(20)">$20</button>
        <button [class.selected]="companyDevelopmentTips.value === 25" 
                (click)="companyDevelopmentTips.setValue(25)">$25</button>
        <div class="custom-tip">
          <input type="number" [formControl]="companyDevelopmentTips" min="0" placeholder="Custom amount">
          <div class="error-message" *ngIf="companyDevelopmentTips.errors?.['minCompanyTipAmount']">
            Custom tip amount must be at least $10
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Step 10/8: Special Instructions -->
  <section class="booking-section">
    <h2>Special Instructions (Optional)</h2>
    <div class="form-group">
      <textarea [formControl]="specialInstructions"
                rows="4" 
                placeholder="Any special instructions for the cleaners..."></textarea>
    </div>
  </section>
</ng-container>

<!-- Entry Method - Visible for both regular and custom pricing (but not for polls) -->
<section class="booking-section" *ngIf="selectedServiceType && !showPollForm">
  <h2>Entry Method</h2>
  <div class="form-group">
    <select [formControl]="entryMethod" id="entryMethod">
      <option value="">Select entry method</option>
      <option *ngFor="let method of entryMethods" [value]="method">{{ method }}</option>
    </select>
    <div class="error-message" *ngIf="entryMethod.invalid && entryMethod.touched">
      <div *ngIf="entryMethod.errors?.['required']">Entry method is required</div>
    </div>
    <input type="text" 
            [formControl]="customEntryMethod"
            placeholder="Please specify"
            *ngIf="entryMethod.value === 'Other'">
  </div>
</section>

<!-- Contact Information and Address - ALWAYS VISIBLE when service type is selected -->
<ng-container *ngIf="selectedServiceType">
  <!-- Step 11/9: Contact Information -->
  <section class="booking-section">
    <h2>Contact Information</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>First Name <span class="required">*</span></label>
        <input type="text" [formControl]="contactFirstName" id="contactFirstName">
        <div class="error-message" *ngIf="contactFirstName.invalid && contactFirstName.touched">
          <div *ngIf="contactFirstName.errors?.['required']">First name is required</div>
        </div>
      </div>
      <div class="form-group">
        <label>Last Name <span class="required">*</span></label>
        <input type="text" [formControl]="contactLastName" id="contactLastName">
        <div class="error-message" *ngIf="contactLastName.invalid && contactLastName.touched">
          <div *ngIf="contactLastName.errors?.['required']">Last name is required</div>
        </div>
      </div>
      <div class="form-group">
        <label>Email <span class="required">*</span></label>
        <input type="email" [formControl]="contactEmail" id="contactEmail">
        <div class="error-message" *ngIf="contactEmail.invalid && contactEmail.touched">
          <div *ngIf="contactEmail.errors?.['required']">Email is required</div>
          <div *ngIf="contactEmail.errors?.['email']">Please enter a valid email address</div>
        </div>
      </div>
      <div class="form-group">
        <label>Phone <span class="required">*</span></label>
        <input type="tel" [formControl]="contactPhone" placeholder="1234567890" id="contactPhone">
        <div class="error-message" *ngIf="contactPhone.invalid && contactPhone.touched">
          <div *ngIf="contactPhone.errors?.['required']">Phone number is required</div>
          <div *ngIf="contactPhone.errors?.['pattern']">Please enter a valid 10-digit phone number</div>
        </div>
      </div>
    </div>

    
  </section>

  <!-- Step 12/10: Service Address -->
  <section class="booking-section">
    <h2>Service Address</h2>
    
    <!-- Saved Address Dropdown - Always visible if user has apartments -->
    <div class="address-options" *ngIf="userApartments.length > 0">
      <div class="saved-address-container">
        <label>Saved Addresses</label>
        <div class="dropdown-with-clear">
          <select [formControl]="selectedApartmentId" (change)="onApartmentSelect($event)">
            <option value="">Enter new address</option>
            <option *ngFor="let apt of userApartments" [value]="apt.id">
              {{ apt.name }} - {{ apt.address }}
            </option>
          </select>
          <button type="button" 
                  class="clear-btn" 
                  *ngIf="selectedApartmentId.value"
                  (click)="clearApartmentSelection()">
            Clear
          </button>
        </div>
      </div>
    </div>
    
    <!-- Address Name Field - Only show when entering new address -->
    <div class="form-group" *ngIf="!selectedApartmentId.value">
      <label>Address Name <span class="required">*</span> <small>(e.g., Home, Office, Mom's House)</small></label>
      <input type="text" 
              [formControl]="apartmentName"
              placeholder="Give this address a name"
              maxlength="100"
              id="apartmentName">
      <div class="error-message" *ngIf="apartmentName.invalid && apartmentName.touched">
        <div *ngIf="apartmentName.errors?.['required']">Address name is required</div>
      </div>
    </div>
    
    <div class="form-grid">
      <div class="form-group full-width">
        <label>Address <span class="required">*</span></label>
        <input type="text" [formControl]="serviceAddress" id="serviceAddress">
        <div class="error-message" *ngIf="serviceAddress.invalid && serviceAddress.touched">
          <div *ngIf="serviceAddress.errors?.['required']">Service address is required</div>
        </div>
      </div>
      <div class="form-group">
        <label>Apt/Suite</label>
        <input type="text" [formControl]="aptSuite">
      </div>
      <div class="form-group">
        <label>City <span class="required">*</span></label>
        <select [formControl]="city" id="city">
          <option value="">Select city</option>
          <option *ngFor="let city of cities" [value]="city">{{ city }}</option>
        </select>
        <div class="error-message" *ngIf="city.invalid && city.touched">
          <div *ngIf="city.errors?.['required']">City is required</div>
        </div>
      </div>
      <div class="form-group">
        <label>State <span class="required">*</span></label>
        <select [formControl]="state" (change)="onStateChange(state.value)" id="state">
          <option value="">Select state</option>
          <option *ngFor="let state of states" [value]="state">{{ state }}</option>
        </select>
        <div class="error-message" *ngIf="state.invalid && state.touched">
          <div *ngIf="state.errors?.['required']">State is required</div>
        </div>
      </div>
      <div class="form-group">
        <label>Zip Code <span class="required">*</span></label>
        <input type="text" [formControl]="zipCode" placeholder="12345" id="zipCode">
        <div class="error-message" *ngIf="zipCode.invalid && zipCode.touched">
          <div *ngIf="zipCode.errors?.['required']">Zip code is required</div>
          <div *ngIf="zipCode.errors?.['pattern']">Please enter a valid 5-digit zip code</div>
        </div>
      </div>
    </div>
  </section>
</ng-container>

<!-- Photo Upload Section -->
<section class="booking-section" *ngIf="selectedServiceType">
  <h2>Upload Photos (Optional)</h2>
  <p class="upload-description">
    You can upload up to {{ maxPhotos }} photos to help us better understand your cleaning needs.
  </p>
  
  <div class="photo-upload-section">
    <div class="upload-container">
      <!-- Mobile-friendly upload options -->
      <div class="upload-options" *ngIf="uploadedPhotos.length < maxPhotos">
        <!-- Take Photo Button (Mobile Only) -->
        <div class="upload-button" *ngIf="isMobileDevice">
          <input 
            type="file" 
            id="camera-capture" 
            accept="image/*"
            capture="environment"
            (change)="onPhotoSelect($event)"
            [disabled]="isUploadingPhoto"
            #cameraInput
          >
          <label for="camera-capture" class="upload-label camera">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 15.2a3.2 3.2 0 1 0 0-6.4 3.2 3.2 0 0 0 0 6.4z"/>
              <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
            </svg>
            <span>Take Photo</span>
          </label>
        </div>
        
        <!-- Upload from Gallery Button -->
        <div class="upload-button">
          <input 
            type="file" 
            id="photo-upload" 
            [accept]="acceptedFormats"
            multiple
            (change)="onPhotoSelect($event)"
            [disabled]="isUploadingPhoto"
            #photoInput
          >
          <label for="photo-upload" class="upload-label gallery">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19M17,13H13V17H11V13H7V11H11V7H13V11H17V13Z"/>
            </svg>
            <span>{{ isMobileDevice ? 'Choose from Gallery' : 'Upload Photos' }}</span>
            <small>{{ uploadedPhotos.length }}/{{ maxPhotos }}</small>
          </label>
        </div>
      </div>
      
      <!-- Photo previews -->
      <div class="photo-previews" *ngIf="uploadedPhotos.length > 0">
        <div class="photo-preview" *ngFor="let photo of uploadedPhotos; let i = index">
          <img [src]="photo.preview" [alt]="photo.file.name">
                  <button 
          type="button" 
          class="remove-photo" 
          (click)="removePhoto(i)"
          title="Remove photo"
        >
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
          </svg>
        </button>
          <span class="photo-name">{{ photo.file.name }}</span>
        </div>
      </div>
      
      <!-- Loading indicator -->
      <div class="upload-loading" *ngIf="isUploadingPhoto">
        <svg class="loading-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z">
            <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
          </path>
        </svg>
        <span>Processing photo...</span>
      </div>
      
      <!-- Error message -->
      <div class="upload-error" *ngIf="photoUploadError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
        </svg>
        {{ photoUploadError }}
      </div>
    </div>
  </div>

  <!-- SMS Consent Checkbox -->
  <div class="sms-consent-section">
    <div class="checkbox-group">
      <input 
        type="checkbox" 
        id="smsConsent" 
        [formControl]="smsConsent" 
        class="form-checkbox"
        [class.error]="smsConsent.invalid && smsConsent.touched">
      <label for="smsConsent" class="checkbox-label">
        I consent to receive Customer care text messages from Dream Cleaning. Reply STOP to opt-out; Reply HELP for support; Message and data rates apply; Messaging frequency may vary. Visit 
        <a routerLink="/privacy-policy" target="_blank">Privacy Policy</a> and 
        <a routerLink="/terms-and-conditions" target="_blank">Terms of Service</a>. <span class="required">*</span>
      </label>
    </div>
    <div class="error-message" *ngIf="smsConsent.invalid && smsConsent.touched">
      <div *ngIf="smsConsent.errors?.['required']">SMS consent is required to proceed with booking</div>
    </div>
  </div>

  <!-- Cancellation Fee and Booking Details Consent Checkbox -->
  <div class="cancellation-consent-section">
    <div class="checkbox-group">
      <input 
        type="checkbox" 
        id="cancellationConsent" 
        [formControl]="cancellationConsent" 
        class="form-checkbox"
        [class.error]="cancellationConsent.invalid && cancellationConsent.touched">
              <label for="cancellationConsent" class="checkbox-label">
          I understand that I will be charged a $70 cancellation fee if I cancel or reschedule my appointment less than 48 hours before the scheduled service. I also confirm that the booking details accurately reflect the cleaning requirements. If the actual condition differs from the described details, Dream Cleaning Team reserves the right to either leave or adjust the services to match the actual condition. I understand, that cleaning lady may arrive within a 30-60 minute window of the scheduled cleaning time. <span class="required">*</span>
        </label>
    </div>
    <div class="error-message" *ngIf="cancellationConsent.invalid && cancellationConsent.touched">
      <div *ngIf="cancellationConsent.errors?.['required']">Cancellation fee and booking details consent is required to proceed with booking</div>
    </div>
  </div>
</section>

        <!-- Book Now Button -->
        <div class="book-now-section" *ngIf="selectedServiceType">
          <button class="book-now-btn" 
                  [disabled]="isLoading"
                  (click)="onSubmit()"
                  [class.disabled]="!isFormValid() || isLoading">
            {{ isLoading ? 'Processing...' : (showPollForm ? 'Send for Quote' : 'Book Now') }}
          </button>
          
          <!-- Payment Note -->
          <div class="payment-note">
            <p><span class="note-label">Please note:</span> We accept credit or debit cards, and all online payments are securely processed through Stripe. When you book with Dream Cleaning, you can rest assured that your transaction is safe and protected. By ordering our services and providing your credit card details, you consent to us charging your card for the service fee.</p>
          </div>
        </div>
      </div>

      <!-- Right Side - Booking Summary (Fixed) -->
<!-- Show summary for regular and custom pricing, but NOT for polls -->
<div class="booking-summary" *ngIf="selectedServiceType && !showPollForm">
  <div class="summary-card" [class.collapsed]="isSummaryCollapsed">
    <h3>Booking Summary</h3>
    
    <div class="summary-details" [class.hidden]="isSummaryCollapsed">
      <div class="summary-item">
        <span>Service Type:</span>
        <span>{{ selectedServiceType.name }}</span>
      </div>
      
      <!-- Custom Pricing Details -->
      <ng-container *ngIf="showCustomPricing">
        <div class="summary-item">
          <span>Number of Cleaners:</span>
          <span>{{ customCleaners.value }}</span>
        </div>
        
        <div class="summary-item">
          <span>Duration:</span>
          <span>{{ formatDuration(customDuration.value) }}</span>
        </div>
      </ng-container>
      
      <!-- Regular Booking Details -->
      <ng-container *ngIf="!showCustomPricing">
        <div class="summary-item" *ngIf="selectedSubscription">
          <span>Subscription:</span>
          <span>{{ selectedSubscription.name }}</span>
        </div>
        
        <div class="summary-item">
          <span>Duration:</span>
          <span>{{ formatDuration(calculation.totalDuration) }}</span>
        </div>
        
        <div class="summary-item">
          <span>Number of Cleaners:</span>
          <span>{{ calculatedMaidsCount }}</span>
        </div>
      </ng-container>
      
      <!-- Common Details for Both -->
      <div class="summary-item" *ngIf="serviceDate.value && serviceTime.value">
        <span>Date & Time:</span>
        <span>{{ serviceDate.value | date:'MMM d' }} at {{ formatTime(serviceTime.value) }}</span>
      </div>
    </div>

    <div class="price-breakdown" [class.hidden]="isSummaryCollapsed">
      <div class="price-item">
        <span>Subtotal:</span>
        <span>${{ calculation.subTotal.toFixed(2) }}</span>
      </div>

      <!-- Show subscription discount if active -->
      <div class="price-item subscription-discount" *ngIf="subscriptionDiscountAmount > 0">
        <span>Subscription Discount ({{ userSubscription?.discountPercentage }}%):</span>
        <span class="discount">-${{ subscriptionDiscountAmount.toFixed(2) }}</span>
      </div>
      
      <!-- Show promo/first-time/special offer discount if active -->
      <div class="price-item" *ngIf="promoOrFirstTimeDiscountAmount > 0">
        <span>
          <ng-container *ngIf="specialOfferApplied && selectedSpecialOffer">
            {{ selectedSpecialOffer.name }}
            <ng-container *ngIf="selectedSpecialOffer.isPercentage">({{ selectedSpecialOffer.discountValue }}%)</ng-container>
          </ng-container>
          <ng-container *ngIf="firstTimeDiscountApplied && !specialOfferApplied">
            First-Time Discount ({{ firstTimeDiscountPercentage }}%)
          </ng-container>
          <ng-container *ngIf="promoCodeApplied && !firstTimeDiscountApplied && !specialOfferApplied">
            Promo Code Discount
            <ng-container *ngIf="promoIsPercentage">({{ promoDiscount }}%)</ng-container>
          </ng-container>
        </span>
        <span class="discount">-${{ promoOrFirstTimeDiscountAmount.toFixed(2) }}</span>
      </div>

      <!-- Gift card discount -->
      <div class="price-item gift-card-discount" *ngIf="giftCardApplied">
        <span>Gift Card Discount:</span>
        <span class="discount">-${{ getGiftCardDisplayInfo().amountToUse.toFixed(2) }}</span>
      </div>

      <div class="price-item">
        <span>Sales Tax (8.875%):</span>
        <span>${{ calculation.tax.toFixed(2) }}</span>
      </div>
      
      <div class="price-item" *ngIf="tips.value > 0">
        <span>Tips for Cleaners:</span>
        <span>${{ (tips.value || 0).toFixed(2) }}</span>
      </div>
      
      <div class="price-item" *ngIf="companyDevelopmentTips.value > 0">
        <span>Tips for Company Development:</span>
        <span>${{ (companyDevelopmentTips.value || 0).toFixed(2) }}</span>
      </div>
    </div>
    
    <!-- Fixed Total Section with Toggle -->
    <div class="total-section">
      <div class="total">
        <span>Total:</span>
        <span>${{ calculation.total.toFixed(2) }}</span>
      </div>
      <button class="summary-toggle" (click)="toggleBookingSummary()" type="button">
        <!-- Chevron down when collapsed -->
        <svg class="chevron-icon" *ngIf="isSummaryCollapsed" viewBox="0 0 24 24" fill="currentColor">
          <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </svg>
        <!-- Red X when expanded -->
        <svg class="close-icon" *ngIf="!isSummaryCollapsed" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>

    <!-- Show next order discount for subscription -->
    <div class="next-order-info" *ngIf="selectedSubscription && (selectedSubscription.subscriptionDays || 0) > 0 && !hasActiveSubscription" [class.hidden]="isSummaryCollapsed">
      <div class="divider"></div>
      <div class="next-order-title">Next Order with {{ selectedSubscription.name }} Subscription:</div>
      <div class="price-item">
        <span>Discount ({{ selectedSubscription.discountPercentage }}%):</span>
        <span class="discount">-${{ nextOrderDiscount.toFixed(2) }}</span>
      </div>
      <div class="price-item next-total">
        <span>Next Order Total:</span>
        <span>${{ nextOrderTotal.toFixed(2) }}</span>
      </div>
    </div>
  </div>
</div>


    </div>
  </div>
</div>